{
{{$email := $.mail}}
{{ if not $.mail}}
{{$email = $.userPrincipalName}}
{{end}}
  "objects": [
    {
      "key": "{{ $.id }}",
      "type": "user",
      "displayName": "{{ $.displayName }}",
      "created_at":"{{ $.createdDateTime }}",
      "properties":{
        "email": "{{ $email }}"
      }
    },
    {
      "key": "{{ $email }}",
      "type": "identity",
      "properties": {
        "verified": true,
        "provider": "azuread"
      }
    },
    {
      "key": "{{ $.id }}",
      "type": "identity",
      "properties": {
        "verified": true,
        "provider": "azuread"
      }
    }
    {{ if $.mobilePhone }}
    ,
      {
          "key": "{{ $.mobilePhone }}",
          "type": "identity",
          "properties": {
            "verified": false,
            "provider": "azuread"
          }
      }
    {{ end }}
  ],
  "relations":[  
    {  
      "relation": "identifier",
      "subject": {
        "type": "user",
        "key": "{{$.id}}"
      },
      "object": {
        "type": "identity",
        "key": "{{$.id}}"
      }
    },
    {  
      "relation": "identifier",
      "subject": {
        "type": "user",
        "key": "{{$.id}}"
      },
      "object": {
        "type": "identity",
        "key": "{{$email}}"
      }
    }
    {{ if $.mobilePhone }}
    ,
    {  
      "relation": "identifier",
      "subject": {
        "type": "user",
        "key": "{{$.id}}"
      },
      "object": {
        "type": "identity",
        "key": "{{$.mobilePhone}}"
      }
    }
    {{ end }}
  ]
}
